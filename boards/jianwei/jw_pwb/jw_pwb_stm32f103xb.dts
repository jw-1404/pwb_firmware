/dts-v1/;

#include <st/f1/stm32f103Xb.dtsi>
#include <st/f1/stm32f103c(8-b)tx-pinctrl.dtsi>
#include "jw_pwb_common.dtsi"

/{
	model = "JianWei Power Supply Board (stm32f103)";
	compatible = "jw,pwb-stm32f103";

	chosen {
		zephyr,console = &usart1;
		zephyr,shell-uart = &usart1;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &code_partition;
	};

  aliases {
		watchdog0 = &iwdg;
	};
};

// &flash0 {
// 	partitions {
// 		compatible = "fixed-partitions";
// 		#address-cells = <1>;
// 		#size-cells = <1>;

// 		boot_partition: partition@0 {
// 			label = "mcuboot";
// 			reg = <0x00000000 DT_SIZE_K(8)>;
// 			read-only;
// 		};

// 		/*
// 		 * The flash starting at offset 0x2000 and ending at
// 		 * offset 0x3999 is reserved for use by the application.
// 		 */

// 		slot0_partition: partition@4000 {
// 			label = "image-0";
// 			reg = <0x00004000 DT_SIZE_K(24)>;
// 		};
// 		slot1_partition: partition@a000 {
// 			label = "image-1";
// 			reg = <0x0000a000 DT_SIZE_K(24)>;
// 		};
// 	};
// };

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		code_partition: partition@0 {
			label = "code";
			reg = <0x00000000 DT_SIZE_K(96)>;
			read-only;
		};

		/* [todo: from nucleo_f103rb] Set 32KB of storage at the end of 128KB flash */
		storage_partition: partition@18000 {
			label = "storage";
			reg = <0x00018000 DT_SIZE_K(32)>;
		};
	};
};

/* [todo] clocks: max sysclk allowed is 72 MHz */

/* uncomment it for RTC */
// &clk_lsi {
// 	status = "okay";
// };

// &rtc {
// 	clocks = <&rcc STM32_CLOCK_BUS_APB1 0x10000000>,
// 		 <&rcc STM32_SRC_LSI RTC_SEL(2)>;
// 	status = "okay";
// };

/* [todo] incorrect oscillator used currently */
// &clk_hse {
// 	clock-frequency = <DT_FREQ_M(8)>;
// 	status = "okay";
// };

&clk_hsi {
  status = "okay";
};

/* by default, PLL clock will be divided by 1.5 to get USB 48 MHz clock */
&pll {
	mul = <9>; // use 72 MHz
	clocks = <&clk_hsi>; // [todo] use hse to enable USB port
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(72)>;
	ahb-prescaler = <1>; // 72 MHz
	apb1-prescaler = <2>; // max 36 MHz
	apb2-prescaler = <1>; // 72 MHz
};

/* watchdog */
&iwdg {
	status = "okay";
};

// [todo] needed?
&dma1 {
	status = "okay";
};

/* communication: */

/* - uart1 for debug-console */
&usart1 {
	pinctrl-0 = <&usart1_tx_pa9 &usart1_rx_pa10>;
	pinctrl-names = "default";
	current-speed = <115200>;
	status = "okay";
};

/* - uart2 for modbus */
&usart2 {
	pinctrl-0 = <&usart2_tx_pa2 &usart2_rx_pa3>;
	pinctrl-names = "default";
	// current-speed = <115200>; // [todo] needed?
	status = "okay";

	modbus0 {
		compatible = "zephyr,modbus-serial";
		status = "okay";

		de-gpios = <&gpiob 9 GPIO_ACTIVE_HIGH>;
	};
};

/* peripherals: */

/* - ch encoder for adc measurmeant */
&adc_encoder {
  status = "okay";
  gpios = <&gpiob 0  (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>,
          <&gpiob 2  (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>,
          <&gpiob 1  (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>;
};

/* - adc for V/I measuremet */
&spi2 {
	pinctrl-0 = <&spi2_nss_master_pb12 &spi2_sck_master_pb13
		          &spi2_miso_master_pb14 &spi2_mosi_master_pb15>;
	pinctrl-names = "default";
	clock-frequency = <1125000>; // limit it to 1.25 MHz (36 MHz/32)
	status = "okay";

	cs-gpios = <&gpiob 12 GPIO_ACTIVE_HIGH>;
  ltc2450@0 {
    compatible = "lltc,ltc2450";
    reg = <0>;
    status = "okay";

		spi-max-frequency = <2000000>; // max: 2 MHz
    duplex = <2048>; // half-duplex
  };
};

/* - dac  for V set */
&spi1 {
	pinctrl-0 = <&spi1_nss_master_pa4 &spi1_sck_master_pa5
		          &spi1_miso_master_pa6 &spi1_mosi_master_pa7>;
	pinctrl-names = "default";
	clock-frequency = <9000000>; // limit it to 9 MHz (72 MHz/8)
	status = "okay";

  cs-gpios = <&gpioa 4 GPIO_ACTIVE_LOW>,
             <&gpiob 5 GPIO_ACTIVE_LOW>,
             <&gpiob 4 GPIO_ACTIVE_LOW>,
             <&gpiob 3 GPIO_ACTIVE_LOW>;

  volt_ch0: dac@0{
    compatible = "adi,ad5541";
    status = "okay";
    reg = <0x0>;
	  spi-max-frequency = <25000000>; // max: 25 MHz
    duplex = <2048>; // half-duplex
  };

  volt_ch1: dac@1{
    compatible = "adi,ad5541";
    status = "okay";
    reg = <0x1>;
	  spi-max-frequency = <25000000>; // max: 25 MHz
    duplex = <2048>; // half-duplex
  };

  volt_ch2: dac@2{
    compatible = "adi,ad5541";
    status = "okay";
    reg = <0x2>;
	  spi-max-frequency = <25000000>; // max: 25 MHz
    duplex = <2048>; // half-duplex
  };

  volt_ch3: dac@3{
    compatible = "adi,ad5541";
    status = "okay";
    reg = <0x3>;
	  spi-max-frequency = <25000000>; // max: 25 MHz
    duplex = <2048>; // half-duplex
  };
};

/* - w1 for uuid */
&w1_bus {
  gpios = <&gpioa 1 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN | GPIO_PULL_UP)>;
  status = "okay";
};

/* - sensor for temperature */
&i2c1 {
	pinctrl-0 = <&i2c1_scl_pb6 &i2c1_sda_pb7>;
	pinctrl-names = "default";
	status = "okay";
	clock-frequency = <I2C_BITRATE_FAST>;

	sht3xd@44 {
		compatible = "sensirion,sht3xd";
		reg= <0x44>;
    status = "okay";

		alert-gpios = <&gpioa 0 GPIO_ACTIVE_HIGH>;
	};
};

/* expansion port (i.e. labelled uart3 port in PCB design */
&i2c2 {
	pinctrl-0 = <&i2c2_scl_pb10 &i2c2_sda_pb11>;
	pinctrl-names = "default";
	clock-frequency = <I2C_BITRATE_FAST>;
};

&usart3 {
	pinctrl-0 = <&usart3_tx_pb10 &usart3_rx_pb11>;
	pinctrl-names = "default";
	current-speed = <115200>;
};

/* [todo] usb port (must have valid hse clock) */
zephyr_udc0: &usb {
	pinctrl-0 = <&usb_dm_pa11 &usb_dp_pa12>;
	pinctrl-names = "default";
  status = "disabled";
	// disconnect-gpios = <&gpioc 11 GPIO_ACTIVE_LOW>;
};